<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bonsai IDE</title>
    <style>
        .code-block {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px 0;
            white-space: pre-wrap;
            background: #f9f9f9;
        }

        .loading {
            font-style: italic;
            color: #888;
        }

        .version-label {
            font-weight: bold;
            margin-bottom: 5px;
        }

        /* Activity palette (match extension.ts getActivityColor) */
        :root {
            --color-tests: #970071;
            /* indigo */
            --color-refactor: #006d18;
            /* golden yellow */
            --color-exceptions: #00b0b6;
            /* warm orange */
            --color-agent-md: #4c51bf;
            /* purple-blue for agent.md alternatives */
            --color-other: #777777;
            /* neutral dark gray */
        }

        .btn-activity {
            appearance: none;
            border: 0;
            padding: 8px 10px;
            border-radius: 8px;
            font-weight: 600;
            color: #fff;
            background: var(--btn-color, #7f7f7f);
            cursor: pointer;
            transition: transform .05s ease, filter .15s ease, opacity .15s ease;
        }

        .btn-activity:hover {
            transform: translateY(-1px);
        }

        .btn-activity:active {
            transform: translateY(0);
        }

        .btn-activity:disabled {
            cursor: not-allowed;
            filter: grayscale(35%) opacity(.8);
        }

        /* Map data-activity -> button color */
        .btn-activity[data-activity="gen_tests"] {
            --btn-color: var(--color-tests);
        }

        .btn-activity[data-activity="refactor"] {
            --btn-color: var(--color-refactor);
        }

        .btn-activity[data-activity="exceptions"] {
            --btn-color: var(--color-exceptions);
        }

        .btn-activity[data-activity="agent_md_alternative"] {
            --btn-color: var(--color-agent-md);
        }

        /* Legend pills */
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 8px 0 2px;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 12px;
            color: #222;
            background: #f3f3f3;
            border: 1px solid #ddd;
        }

        .swatch {
            display: inline-block;
            width: 20px;
            height: 12px;
            border-radius: 6px;
        }

        .swatch.gradient {
            width: 60px;
            background: linear-gradient(to right, blue, yellow);
            border: 1px solid #ccc;
        }

        .swatch.gen_tests {
            background: var(--color-tests);
        }

        .swatch.refactor {
            background: var(--color-refactor);
        }

        .swatch.exceptions {
            background: var(--color-exceptions);
        }

        .swatch.agent_md_alternative {
            background: var(--color-agent-md);
        }

        .swatch.other {
            background: var(--color-other);
        }

        /* Connection test status */
        #connectionTestStatus {
            font-size: 13px;
            padding: 4px 8px;
            border-radius: 4px;
        }

        #connectionTestStatus.connection-testing { color: #856404; background: #fff3cd; }
        #connectionTestStatus.connection-success { color: #155724; background: #d4edda; }
        #connectionTestStatus.connection-error   { color: #721c24; background: #f8d7da; }

        /* Agent.md process button and status */
        .btn-process-agent {
            appearance: none;
            border: 0;
            padding: 8px 14px;
            border-radius: 8px;
            font-weight: 600;
            color: #fff;
            background: #5a67d8;
            cursor: pointer;
            transition: transform .05s ease, filter .15s ease, opacity .15s ease;
        }
        .btn-process-agent:hover { transform: translateY(-1px); background: #4c51bf; }
        .btn-process-agent:active { transform: translateY(0); }
        .btn-process-agent:disabled { cursor: not-allowed; filter: grayscale(35%) opacity(.8); }

        #agentMdProcessStatus {
            font-size: 13px;
            padding: 4px 8px;
            border-radius: 4px;
        }
        #agentMdProcessStatus.processing { color: #856404; background: #fff3cd; }
        #agentMdProcessStatus.success { color: #155724; background: #d4edda; }
        #agentMdProcessStatus.error { color: #721c24; background: #f8d7da; }

        #generateAgentMdStatus {
            font-size: 13px;
            padding: 4px 8px;
            border-radius: 4px;
        }
        #generateAgentMdStatus.processing { color: #856404; background: #fff3cd; }
        #generateAgentMdStatus.success { color: #155724; background: #d4edda; }
        #generateAgentMdStatus.error { color: #721c24; background: #f8d7da; }
    </style>

</head>

<body>
    <h2>Bonsai</h2>
    <!-- Legend (matches node colors) -->
    <div class="legend">
        <span class="pill"><span class="swatch gen_tests"></span>Generate tests</span>
        <span class="pill"><span class="swatch refactor"></span>Refactor</span>
        <span class="pill"><span class="swatch exceptions"></span>Handle exceptions</span>
        <span class="pill"><span class="swatch agent_md_alternative"></span>Agent.md alternative</span>
        <span class="pill"><span class="swatch other"></span>Other</span>
        <span class="pill">
            <span class="swatch gradient"></span>Border: Code Similarity (Less ‚Üí More)
        </span>
    </div>
    <div style="margin:6px 0; display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
        <label>LM_Studio URL:
            <input id="baseUrlInput" type="text" size="40" placeholder="http://localhost:1234/v1" />
        </label>
        <label>Model:
            <input id="modelInput" type="text" size="40" placeholder="deepseek/deepseek-r1-0528-qwen3-8b" />
        </label>
        <button id="btnTestConnection" title="Test connection to LM Studio" aria-label="Test connection to LM Studio">Test Connection</button>
        <span id="connectionTestStatus" aria-live="polite"></span>
    </div>
    <!-- Bonsai Graph -->
    <div id="graph" style="width: 100%; height: 500px; border: 1px solid #ddd;"></div>
    <button id="btnExportJson" title="Export current Bonsai as JSON">Export JSON</button>
    <button id="btnImportJson" title="Import Bonsai from JSON">Import JSON</button>

    <h2>Agent.md Processing</h2>
    <div style="margin-bottom:4px;">
        <button id="btnLoadAgentMd" title="Load an agent.md file for processing">üìÑ Load Agent.md</button>
        <span id="agentMdFilename" style="margin-left:8px; font-style:italic; color:#666;"></span>
    </div>
    <textarea style="width: 100%;" id="agentMdContent" rows="8" cols="60" placeholder="Paste or load your Agent.md content here. This will be processed by the LLM to generate source code."></textarea>
    <div style="margin-top:6px; margin-bottom:12px;">
        <button id="btnProcessAgentMd" class="btn-process-agent" title="Process the Agent.md content with the LLM to generate source code">‚ö° Process Agent.md</button>
        <span id="agentMdProcessStatus" style="margin-left:8px;"></span>
    </div>

    <h2>Generate AGENTS.MD from GitHub Repository</h2>
    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:8px;">
        <label>GitHub Repository URL:
            <input id="githubRepoUrl" type="text" size="50" placeholder="https://github.com/owner/repo" />
        </label>
        <button id="btnGenerateAgentMd" title="Fetch repository from GitHub and generate AGENTS.MD using LLM">üìù Generate AGENTS.MD</button>
        <span id="generateAgentMdStatus" style="margin-left:8px;"></span>
    </div>
    <textarea style="width:100%; display:none;" id="generatedAgentMd" rows="15" cols="60" readonly placeholder="Generated AGENTS.MD content will appear here..."></textarea>

    <h2>Source code of the node selected</h2>
    <textarea style="width: 100%;" id="code" rows="10"
        cols="60">def hello():\n    print(\"Hello, world!\")</textarea><br>
    <!-- Collapsible Reasoning Panel -->
    <details id="reasoningPanel" style="margin-top:8px;">
        <summary style="cursor:pointer; font-weight:600;">Reasoning</summary>
        <pre id="reasoningContent" class="code-block" style="max-height:280px; overflow:auto; margin-top:6px;"></pre>
    </details>
    <hr>
    <!-- Activities Panel -->
    <h2>Activities</h2>

    <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:8px;">
        <button id="btnGenerateAlternatives" class="btn-activity" data-activity="agent_md_alternative"
            title="Generate multiple alternatives based on Agent.md content">‚ö° Generate Alternatives from Agent.md</button>
        <button id="btnGenTests" class="btn-activity" data-activity="gen_tests"
            title="Generate unit tests">Generate tests</button>
        <button id="btnRefactor" class="btn-activity" data-activity="refactor"
            title="Refactor the code (no behavior change)">Refactor</button>
        <button id="btnExceptions" class="btn-activity" data-activity="exceptions"
            title="Harden exception handling">Handle exceptions</button>
    </div>

    <input hidden id="prompt" type="text" placeholder="Enter prompt" size="60" /><br>
    <label>Branches: <input type="number" id="versionCount" value="1" min="1" max="10" style="width: 50px;" /></label>
    <button hidden onclick="sendPrompt()">Generate</button>
    <div id="log"></div>
    
    <hr>

    <h2>Code Similarity</h2>
    <div style="width:100px;" id="similarities"></div>
    <hr>
    <h2>Code metrics</h2>
    <div id="metrics"></div>
    <hr>
    <h2>Prompts and outputs</h2>
    <div id="output"></div>


    <script>
        /**
         * vscode compatibility shim.
         *
         * When running inside a VS Code Webview, acquireVsCodeApi() is available and
         * we use it directly (original behaviour, unchanged).
         *
         * When running as a standalone web page served by the BonsAIDE HTTP server
         * (npm run serve), acquireVsCodeApi is not defined.  In that case we create a
         * drop-in replacement that:
         *  - Sends messages to the server via HTTP POST /message
         *  - Receives messages from the server via a Server-Sent Events stream on GET /events
         *  - Intercepts exportJSON to trigger a browser download (GET /export)
         *  - Intercepts importJSON to open a <input type="file"> picker, reads the
         *    chosen file, and POSTs its content to POST /message with command importJSON
         */
        const vscode = (function () {
            if (typeof acquireVsCodeApi === 'function') {
                return acquireVsCodeApi();
            }

            // ---- Standalone web mode ----

            // SSE: server ‚Üí browser
            const evtSource = new EventSource('/events');
            evtSource.onmessage = function (e) {
                try {
                    const msg = JSON.parse(e.data);
                    window.dispatchEvent(new MessageEvent('message', { data: msg }));
                } catch (err) { console.error('SSE parse error', err); }
            };
            evtSource.onerror = function () {
                console.warn('SSE connection lost; will retry automatically.');
            };

            // Hidden file input for importing a JSON file
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);
            fileInput.addEventListener('change', function () {
                const file = fileInput.files && fileInput.files[0];
                if (!file) { return; }
                const reader = new FileReader();
                reader.onload = function (ev) {
                    fetch('/message', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ command: 'importJSON', content: ev.target.result })
                    }).catch(err => console.error('Import POST error', err));
                };
                reader.readAsText(file);
                fileInput.value = ''; // reset for re-use
            });

            return {
                postMessage: function (msg) {
                    // Export: trigger a browser download instead of VS Code save dialog
                    if (msg.command === 'exportJSON') {
                        window.location.href = '/export';
                        return;
                    }
                    // Import: open a file picker instead of VS Code open dialog
                    if (msg.command === 'importJSON') {
                        fileInput.click();
                        return;
                    }
                    // All other messages go to the server via POST
                    fetch('/message', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(msg)
                    }).catch(err => console.error('Message POST error', err));
                }
            };
        })();

        // Agent.md file loading (works in both VS Code and standalone web mode)
        (function () {
            const agentMdInputVsc = document.createElement('input');
            agentMdInputVsc.type = 'file';
            agentMdInputVsc.accept = '.md,.markdown';
            agentMdInputVsc.style.display = 'none';
            document.body.appendChild(agentMdInputVsc);
            agentMdInputVsc.addEventListener('change', function () {
                const file = agentMdInputVsc.files && agentMdInputVsc.files[0];
                if (!file) { return; }
                const reader = new FileReader();
                reader.onload = function (ev) {
                    const agentMdEl = document.getElementById('agentMdContent');
                    if (agentMdEl) { agentMdEl.value = ev.target.result; }
                    const nameEl = document.getElementById('agentMdFilename');
                    if (nameEl) { nameEl.textContent = file.name; }
                };
                reader.readAsText(file);
                agentMdInputVsc.value = ''; // reset for re-use
            });
            document.getElementById('btnLoadAgentMd').addEventListener('click', function () {
                agentMdInputVsc.click();
            });
        })();

        // Process Agent.md button handler
        document.getElementById('btnProcessAgentMd').addEventListener('click', function () {
            const agentMdContent = document.getElementById('agentMdContent').value || '';
            const statusEl = document.getElementById('agentMdProcessStatus');
            if (!agentMdContent.trim()) {
                if (statusEl) {
                    statusEl.textContent = 'Please enter or load Agent.md content first.';
                    statusEl.className = 'error';
                }
                return;
            }
            if (statusEl) {
                statusEl.textContent = 'Processing...';
                statusEl.className = 'processing';
            }
            const baseUrl = document.getElementById('baseUrlInput').value || '';
            const model = document.getElementById('modelInput').value || '';
            vscode.postMessage({ 
                command: 'processAgentMd', 
                content: agentMdContent,
                baseUrl,
                model
            });
        });

        document.getElementById('btnExportJson').addEventListener('click', () => {
            vscode.postMessage({ command: 'exportJSON' });
        });

        document.getElementById('btnImportJson').addEventListener('click', () => {
            vscode.postMessage({ command: 'importJSON' });
        });

        document.getElementById('btnTestConnection').addEventListener('click', () => {
            const baseUrl = document.getElementById('baseUrlInput').value || '';
            const model = document.getElementById('modelInput').value || '';
            const statusEl = document.getElementById('connectionTestStatus');
            if (statusEl) {
                statusEl.textContent = 'Testing...';
                statusEl.className = 'connection-testing';
            }
            vscode.postMessage({ command: 'testConnection', baseUrl, model });
        });

        // Generate AGENTS.MD button handler
        document.getElementById('btnGenerateAgentMd').addEventListener('click', () => {
            const repoUrl = document.getElementById('githubRepoUrl').value || '';
            const statusEl = document.getElementById('generateAgentMdStatus');
            if (!repoUrl.trim()) {
                if (statusEl) {
                    statusEl.textContent = 'Please enter a GitHub repository URL.';
                    statusEl.className = 'error';
                }
                return;
            }
            if (statusEl) {
                statusEl.textContent = 'Generating...';
                statusEl.className = 'processing';
            }
            const baseUrl = document.getElementById('baseUrlInput').value || '';
            const model = document.getElementById('modelInput').value || '';
            vscode.postMessage({
                command: 'generateAgentMd',
                repoUrl,
                baseUrl,
                model
            });
        });

        function sendPrompt() {
            const prompt = document.getElementById('prompt').value;
            const code = document.getElementById('code').value;
            const baseUrl = document.getElementById('baseUrlInput').value || '';
            const model = document.getElementById('modelInput').value || '';


            const versionCount = parseInt(document.getElementById('versionCount').value) || 1;
            vscode.postMessage({ command: 'generate', prompt, code, versionCount, activity: 'custom', baseUrl, model });
            document.getElementById('log').innerHTML = '<p class="loading">Generating...</p>';
        }

        //**
        //  Render metrics and similarities
        //**
        function escapeHtml(s) {
            return String(s).replace(/[<>&]/g, c => ({ '<': '&lt;', '>': '&gt;', '&': '&amp;' }[c]));
        }

        function renderSimilarities(baseNode, similarities) {
            const box = document.getElementById('similarities');
            if (!box) return;

            if (!baseNode || !baseNode.isLeaf) {
                box.innerHTML = '<em>No leaf node selected.</em>';
                return;
            }

            if (!similarities || similarities.length === 0) {
                box.innerHTML = `<div><strong>Node #${baseNode.id}</strong> is a leaf. No other leaves to compare.</div>`;
                return;
            }

            const rows = similarities.map(s =>
                `<tr>
        <td>#${s.id}</td>
        <td style="text-align:right">${(s.similarity || 0).toFixed(4)}</td>
      </tr>`
            ).join('');

            box.innerHTML = `
      <div style="margin-top:8px">
        <div><strong>Base leaf:</strong> #${baseNode.id}</div>
        <table style="width:100%; border-collapse: collapse; margin-top:6px">
          <thead>
            <tr>
              <th style="text-align:left; border-bottom:1px solid #ddd">Leaf Node</th>
              <th style="text-align:right; border-bottom:1px solid #ddd">Cosine</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;

        }

        function renderLizardMetrics(node) {
            const box = document.getElementById('metrics');
            if (!box) return;

            if (!node) {
                box.innerHTML = '';
                return;
            }

            const m = node.lizard;
            if (!m) {
                box.innerHTML = `<div style="margin-top:10px"><strong>Lizard metrics:</strong> <em>Not available for node #${node.id}</em></div>`;
                return;
            }

            // Small summary, then full JSON prettified (collapsible)
            const fnCount = m.function_count ?? (m.functions ? m.functions.length : undefined);
            const summary = `
      <div><strong>File:</strong> ${escapeHtml(m.filename ?? '')}</div>
      <div><strong>NLOC:</strong> ${m.nloc ?? '-'}</div>
      <div><strong>Token count:</strong> ${m.token_count ?? '-'}</div>
      <div><strong>Functions:</strong> ${fnCount ?? '-'}</div>
      <div><strong>Average CCN:</strong> ${m.average_ccn ?? '-'}</div>
    `;

            const pretty = escapeHtml(JSON.stringify(m, null, 2));
            box.innerHTML = `
      <div style="margin-top:10px">
        <strong>Lizard metrics for node #${node.id}:</strong>
        <div style="margin-top:6px">${summary}</div>
        <details style="margin-top:8px">
          <summary>Full JSON</summary>
          <pre class="code-block" style="max-height:260px; overflow:auto">${pretty}</pre>
        </details>
      </div>
    `;
        }
        //**

        window.addEventListener('message', event => {
            const message = event.data;

            if (message.command === 'setInitialCode') {
                document.getElementById('code').value = message.code;
            }

            if (message.command === 'loading') {
                document.getElementById('log').innerHTML = '<p class="loading">' + message.text + '</p>';
            }

            if (message.command === 'historyUpdate') {
                const log = document.getElementById('log');
                log.innerHTML = '';
                const container = document.getElementById('output');
                container.innerHTML = '';

                message.history.forEach((state, index) => {
                    const block = document.createElement('div');
                    block.className = 'code-block';
                    const escapedCode = state.code.replace(/[<>&]/g, c => ({ '<': '&lt;', '>': '&gt;', '&': '&amp;' }[c]));
                    block.innerHTML =
                        '<div class="version-label">#' + state.id + ' - Prompt: ' + state.prompt + '</div>' +
                        '<pre>' + escapedCode + '</pre>' +
                        '<button onclick="trimTo(' + state.id + ')">‚úÇ Trim to this</button>';
                    container.appendChild(block);
                });
            }

            if (message.command === 'urlmodelUpdate') {
                const baseUrlInput = document.getElementById('baseUrlInput');
                const modelInput = document.getElementById('modelInput');
                if (baseUrlInput && message.baseUrl) baseUrlInput.value = message.baseUrl;
                if (modelInput && message.LLMmodel) modelInput.value = message.LLMmodel;
            }

            if (message.command === 'connectionTestResult') {
                const statusEl = document.getElementById('connectionTestStatus');
                if (statusEl) {
                    statusEl.textContent = message.message;
                    statusEl.className = message.success ? 'connection-success' : 'connection-error';
                }
            }

            if (message.command === 'agentMdProcessResult') {
                const statusEl = document.getElementById('agentMdProcessStatus');
                if (message.success) {
                    // Put the generated code into the code textarea
                    const codeEl = document.getElementById('code');
                    if (codeEl && message.code) { codeEl.value = message.code; }
                    if (statusEl) {
                        statusEl.textContent = '‚úì Code generated successfully!';
                        statusEl.className = 'success';
                    }
                } else {
                    if (statusEl) {
                        statusEl.textContent = '‚úó ' + (message.message || 'Processing failed');
                        statusEl.className = 'error';
                    }
                }
            }

            if (message.command === 'generateAgentMdResult') {
                const genStatusEl = document.getElementById('generateAgentMdStatus');
                const genTextarea = document.getElementById('generatedAgentMd');
                if (message.success) {
                    if (genTextarea && message.content) {
                        genTextarea.value = message.content;
                        genTextarea.style.display = 'block';
                    }
                    if (genStatusEl) {
                        genStatusEl.textContent = '‚úì AGENTS.MD generated successfully!';
                        genStatusEl.className = 'success';
                    }
                } else {
                    if (genStatusEl) {
                        genStatusEl.textContent = '‚úó ' + (message.message || 'Generation failed');
                        genStatusEl.className = 'error';
                    }
                }
            }

            if (message.command === 'leafSimilarities') {
                // message.node: comlete node selected
                // message.similarities: [{ id, similarity }, ...]
                renderSimilarities(message.node, message.similarities);
                renderLizardMetrics(message.node);

                // Apply similarity heatmap borders only if there are similarities
                if (message?.node && Array.isArray(message.similarities) && message.similarities.length) {
                    applySimilarityBorders(message.node.id, message.similarities);
                } else {
                    resetAllBordersToBaseline(); // non-leaf or no data
                }
            }
        });


        // --- Helpers: baseline + similarity heatmap ---
        function resetAllBordersToBaseline() {
            if (!window.bonsaiCyRef) return;
            window.bonsaiCyRef.nodes().forEach(n => {
                n.removeStyle('border-color');
                n.removeStyle('border-width');
            });
        }

        /** Map similarity in [min,max] to blue‚Üíred rgb */
        function simToHeatColor(sim, minSim, maxSim) {
            let t = (maxSim === minSim) ? 0.5 : (sim - minSim) / (maxSim - minSim);
            t = Math.max(0, Math.min(1, t));

            const r = Math.round(255 * t);         // 0 ‚Üí 255
            const g = Math.round(255 * t);         // 0 ‚Üí 255
            const b = Math.round(255 * (1 - t));   // 255 ‚Üí 0

            return `rgb(${r},${g},${b})`;
        }

        function applySimilarityBorders(baseNodeId, similarities) {
            if (!window.bonsaiCyRef || !similarities || similarities.length === 0) return;

            // Clear previous inline styles so stylesheet/base apply
            resetAllBordersToBaseline();

            const sims = similarities.map(s => s.similarity);

            similarities.forEach(({ id, similarity }) => {
                if (id === baseNodeId) return; // don't touch the base; let .selected show yellow
                const node = window.bonsaiCyRef.getElementById('n' + id);
                if (node && node.nonempty()) {
                    node.style('border-color', simToHeatColor(similarity, 0, 1));
                    node.style('border-width', 20);
                }
            });
        }

        function trimTo(id) {
            vscode.postMessage({ command: 'trim', id });
        }
    </script>


    <script src="https://unpkg.com/cytoscape@3.24.0/dist/cytoscape.min.js"></script>
    <script>
        window.addEventListener('message', event => {
            const message = event.data;
            if (message.command === 'renderGraph') {
                vscode.postMessage({ command: 'unselectNode' });

                console.log('Rendering graph:', message.graph);
                cleanupAllTooltips();
                const cy = cytoscape({
                    container: document.getElementById('graph'),
                    elements: [
                        ...message.graph.nodes,
                        ...message.graph.edges
                    ],
                    style: [
                        {
                            selector: 'node',
                            style: {
                                'label': 'data(label)',
                                'background-color': 'data(activityColor)',
                                'border-color': 'data(activityColor)',
                                'color': '#fff',
                                'text-valign': 'center',
                                'text-halign': 'center',
                                'border-width': 20,
                                //'border-color': '#333',
                                'width': 'data(size)',
                                'height': 'data(size)',
                            }
                        },
                        {
                            selector: '.selected',
                            style: {
                                'border-width': 20,
                                'border-color': 'yellow',
                                'overlay-color': 'yellow',
                                'overlay-opacity': 0.2,   // transparent halo
                                'overlay-padding': 20     // halo size around the node
                            }
                        },
                        {
                            selector: 'edge',
                            style: {
                                'width': 2,
                                'line-color': '#ccc',
                                'target-arrow-color': '#ccc',
                                'target-arrow-shape': 'triangle'
                            }
                        }
                    ],
                    layout: {
                        name: 'breadthfirst',
                        directed: true,
                        padding: 10,
                        spacingFactor: 1.5,
                        orientation: 'vertical',
                        nodeDimensionsIncludeLabels: true,
                        animate: false,
                        transform: (node, position) => ({
                            x: position.x,
                            y: -position.y
                        })
                    }
                });

                window.bonsaiCyRef = cy;

                cy.on('cxttap', 'node', evt => {
                    const id = evt.target.id().slice(1);
                    vscode.postMessage({ command: 'unselectNode' });
                    vscode.postMessage({ command: 'trim', id: parseInt(id) });
                });

                cy.on('tap', 'node', evt => {
                    // Reset borders back to baseline before applying any new similarity map
                    resetAllBordersToBaseline();

                    const id = evt.target.id().slice(1);
                    vscode.postMessage({ command: 'selectNode', id: parseInt(id) });
                    cy.nodes().forEach(n => n.removeClass('selected'));
                    evt.target.addClass('selected');

                    const codeInput = document.getElementById('code');
                    const promptInput = document.getElementById('prompt');
                    const code = evt.target.data('code');
                    const prompt = evt.target.data('prompt');
                    if (codeInput) codeInput.value = code;
                    if (promptInput) promptInput.value = prompt;

                    const reasoningPanel = document.getElementById('reasoningPanel');
                    const reasoningContent = document.getElementById('reasoningContent');
                    const reasoning = (evt.target.data('reasoning') || '').toString();
                    const escape = s => s.replace(/[<>&]/g, c => ({ '<': '&lt;', '>': '&gt;', '&': '&amp;' }[c]));

                    if (reasoning && reasoning.trim().length > 0) {
                        reasoningContent.innerHTML = escape(reasoning);
                        // keep it collapsed by default; uncomment next line to auto-open
                        // reasoningPanel.setAttribute('open','');
                        reasoningPanel.style.display = '';
                    } else {
                        reasoningContent.textContent = '';
                        reasoningPanel.removeAttribute('open');
                        reasoningPanel.style.display = 'none';
                    }
                });

                // After cy is created...
                const container = document.getElementById('graph');
                const containerRect = () => container.getBoundingClientRect();

                // Hide all tooltips when mouse leaves the canvas entirely
                container.addEventListener('mouseleave', hideAllTooltips);

                // Also hide all tooltips on pan/zoom (optional but nice)
                cy.on('pan zoom', hideAllTooltips);

                // Build one tooltip per node
                cy.nodes().forEach(n => {
                    const code = n.data('code') || '';
                    const label = n.data('label') || '';
                    const activity = n.data('activity') || '';

                    const html = `<div style="white-space: pre-wrap; max-width: 360px;">
                    <strong>${label}: ${activity}</strong><br>
                    <pre style="margin:0;">${code.replace(/[<>&]/g, c => ({ '<': '&lt;', '>': '&gt;', '&': '&amp;' }[c]))}</pre>
                    </div>`;

                    const tip = createTooltipEl(html);
                    tooltipsById.set(n.id(), tip);

                    // Show on mouseover; position using container rect + renderedPosition
                    n.on('mouseover', (e) => {
                        const pos = e.target.renderedPosition();
                        const rect = containerRect();
                        // Offset a bit to the right/down from the node center
                        tip.style.left = (rect.left + pos.x + 10) + 'px';
                        tip.style.top = (rect.top + pos.y + 10) + 'px';
                        tip.style.display = 'block';
                    });

                    n.on('mouseout', () => {
                        tip.style.display = 'none';
                    });

                    // If node is removed (e.g., trim), delete its tooltip
                    n.on('remove', () => {
                        if (tip && tip.parentNode) tip.parentNode.removeChild(tip);
                        tooltipsById.delete(n.id());
                    });
                });
            }
        });

        // --- Tooltip utils ---
        const tooltipsById = new Map(); // key: cytoscape node id -> HTMLDivElement

        function createTooltipEl(html) {
            const el = document.createElement('div');
            el.className = 'bonsai-qtip';
            el.style.position = 'fixed';          // use fixed + rect to avoid scroll mismatch
            el.style.background = '#333';
            el.style.color = '#fff';
            el.style.padding = '6px';
            el.style.borderRadius = '4px';
            el.style.fontSize = '12px';
            el.style.display = 'none';
            el.style.zIndex = 1000;
            el.innerHTML = html;
            document.body.appendChild(el);
            return el;
        }

        function hideAllTooltips() {
            for (const el of tooltipsById.values()) el.style.display = 'none';
        }

        function cleanupAllTooltips() {
            for (const el of tooltipsById.values()) {
                if (el && el.parentNode) el.parentNode.removeChild(el);
            }
            tooltipsById.clear();
        }
    </script>

    <script>
        // --- Activity templates (only CODE context is sent by the extension; we only build the prompt) ---
        const ACTIVITY_TEMPLATES = {
            gen_tests: () => `
            You are a senior engineer. Your task is to APPEND unit tests to the provided source code, WITHOUT modifying the source. STRICTLY follow these rules:
            - INCLUDE in the answer the original source code in the prompt. Do NOT change, reorder, format, or delete any line of the original source.
            - Cover the fixed behavior and edge cases. Prefer small, isolated tests.
            - Include any necessary test doubles.
            `.trim(),

            refactor: () => `
            Refactor the given CODE to improve readability, maintainability, and structure WITHOUT changing behavior.
            - Apply small, safe refactorings (naming, decomposition, DRY, cohesion, comments where useful).
            - Do not change external behavior or public API.
            `.trim(),

            exceptions: () => `
            Harden the given CODE with robust error/exception handling.
            - Add meaningful exceptions and messages.
            - Avoid blanket catches; keep failures observable.
            - Do not change external behavior except to handle errors gracefully.
            `.trim(),

            agent_md_alternative: (agentMdContent) => `
            You are an expert software engineer. You will be given CODE (from the user) and an Agent.md specification (below).
            Your task is to generate an ALTERNATIVE implementation based on the Agent.md specification.
            - Generate complete, working code that implements the specification.
            - Consider different approaches, design patterns, or optimization strategies.
            - Maintain clarity and follow best practices.

            AGENT.MD SPECIFICATION:
            ${agentMdContent}`.trim(),
        };

        // --- Flow state: all activities are now always enabled ---
        function setFollowupEnabled(enabled) {
            // No-op: all activities are always enabled now
        }

        function setInitialFixEnabled(enabled) {
            // No-op: fix buttons removed
        }

        function resetFlow() {
            // No-op: all activities are always enabled now
        }

        window.addEventListener('message', (event) => {
            const message = event.data;
            if (message.command === 'setActivityFlow') {
                // No-op: flow management removed
            }
        });

        // Helpers: pull UI state
        function getBaseCode() {
            return document.getElementById('code').value;
        }
        function getVersionCount() {
            const v = parseInt(document.getElementById('versionCount').value, 10);
            return Number.isFinite(v) && v > 0 ? v : 1;
        }

        // Generic runner
        function runActivity(activityKey) {
            let prompt = '';
            if (activityKey === 'gen_tests') {
                prompt = ACTIVITY_TEMPLATES.gen_tests();
            } else if (activityKey === 'refactor') {
                prompt = ACTIVITY_TEMPLATES.refactor();
            } else if (activityKey === 'exceptions') {
                prompt = ACTIVITY_TEMPLATES.exceptions();
            } else if (activityKey === 'agent_md_alternative') {
                const agentMdContent = (document.getElementById('agentMdContent').value || '').trim();
                if (!agentMdContent) {
                    console.log('Please provide Agent.md content first.');
                    return;
                }
                prompt = ACTIVITY_TEMPLATES.agent_md_alternative(agentMdContent);
            } else {
                console.warn('Unknown activity:', activityKey);
                return;
            }

            // Post to VS Code extension (reuse your generate message)
            const baseUrl = document.getElementById('baseUrlInput').value || '';
            const model = document.getElementById('modelInput').value || '';

            vscode.postMessage({
                command: 'generate',
                prompt,
                code: getBaseCode(),
                versionCount: getVersionCount(),
                activity: activityKey,
                baseUrl,
                model
            });

            // Optional: show loading immediately
            document.getElementById('log').innerHTML = '<p class="loading">Generating...</p>';
        }

        // Wire buttons
        document.getElementById('btnGenerateAlternatives').addEventListener('click', () => runActivity('agent_md_alternative'));
        document.getElementById('btnGenTests').addEventListener('click', () => runActivity('gen_tests'));
        document.getElementById('btnRefactor').addEventListener('click', () => runActivity('refactor'));
        document.getElementById('btnExceptions').addEventListener('click', () => runActivity('exceptions'));

        // Initialize (no-op now)
        resetFlow();
    </script>

</body>

</html>